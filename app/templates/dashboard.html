{% extends "base.html" %}

{% block title %}Storage Dashboard - ITscare{% endblock %}

{% block styles %}
/* ITscare Corporate Design - Full HD Optimization (1920x1080) */
:root {
    /* Use Admin Preset Colors */
    --itscare-blue: var(--accent-color);  /* Admin Blue: #0098DB */
    --itscare-blue-dark: #007ab8;  /* Darker shade of admin blue */
    --itscare-blue-light: #33ade3;  /* Lighter shade of admin blue */
    --itscare-red: var(--primary-color);  /* Admin Red: #A70240 */
    --itscare-red-dark: #8a0235;  /* Darker shade of admin red */
    --itscare-green: var(--secondary-color);  /* Admin Green: #BED600 */
    --itscare-green-dark: #a8ba00;  /* Darker shade of admin green */
    
    /* UI Colors */
    --text-dark: #1a1a1a;
    --text-medium: #4a4a4a;
    --text-light: #6a6a6a;
    --bg-light: #f5f7fa;
    --bg-white: #ffffff;
    --border-light: #e1e8ed;
    --warning: #FFA500;
}

body {
    font-size: 14px;
    background: var(--bg-light);
}

.container {
    width: 100%;
    margin: 0;
    padding: 0.75rem;
}

/* Combined Overview Card */
.overview-card {
    background: var(--bg-white);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    margin: 0.5rem 0 1rem 0;
    border-bottom: 4px solid var(--itscare-red);
}

.overview-header {
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-light);
}

.overview-header h2 {
    font-size: 1.5rem;
    color: var(--itscare-blue);
    margin: 0;
    font-weight: 600;
}

.overview-content {
    padding: 1rem 1.5rem;
}

.dashboard-header {
    margin: 0.5rem 0 1rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-white);
    padding: 1rem 1.5rem;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    border-left: 4px solid var(--itscare-blue);
}

.dashboard-header h2 {
    font-size: 1.5rem;
    color: var(--itscare-blue);
    margin: 0;
    font-weight: 600;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.auto-refresh-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-light);
    border-radius: 6px;
    border: 1px solid var(--border-light);
}

.auto-refresh-control select {
    padding: 0.3rem 0.5rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
    color: var(--text-dark);
}

.auto-refresh-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-medium);
    font-weight: 500;
    user-select: none;
}

.auto-refresh-label input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--itscare-green);
}

.refresh-timer {
    font-size: 0.85rem;
    color: var(--itscare-blue);
    font-weight: 600;
    min-width: 80px;
    text-align: right;
}

.refresh-timer.refreshing {
    color: var(--itscare-green);
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.view-toggle {
    display: flex;
    background: var(--bg-light);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border-light);
}

.view-toggle button {
    background: transparent;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-medium);
    transition: all 0.3s;
    font-weight: 500;
}

.view-toggle button:hover {
    background: rgba(0, 102, 204, 0.1);
}

.view-toggle button.active {
    background: var(--itscare-blue);
    color: white;
}

.refresh-btn {
    background: var(--itscare-blue);
    color: white;
    border: none;
    padding: 0.5rem 1.25rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2);
}

.refresh-btn:hover {
    background: var(--itscare-blue-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
}

.vendor-section {
    margin: 0.75rem 0;
}

.vendor-header {
    background: white;
    color: var(--itscare-blue);
    padding: 0.75rem 1.25rem;
    border-radius: 6px 6px 0 0;
    font-size: 1.05rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
    border-bottom: 4px solid var(--itscare-blue);
}

.vendor-count {
    font-size: 0.85rem;
    opacity: 0.7;
    font-weight: 400;
    color: var(--text-medium);
}

/* Card View - Optimized for 25 systems on Full HD */
.systems-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-white);
    border-radius: 0 0 6px 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
}

.system-card {
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 0.85rem;
    background: var(--bg-white);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
}

.system-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--itscare-blue);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.system-card:hover::before {
    transform: scaleX(1);
}

.system-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 102, 204, 0.15);
    border-color: var(--itscare-blue);
}

.system-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.system-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-dark);
    line-height: 1.3;
    flex: 1;
}

.cluster-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    white-space: nowrap;
    margin-left: 0.25rem;
}

.cluster-badge.ha { 
    background: rgba(0, 102, 204, 0.15); 
    color: var(--itscare-blue); 
    border: 1px solid rgba(0, 102, 204, 0.3);
}
.cluster-badge.active-cluster { 
    background: rgba(0, 102, 204, 0.15); 
    color: var(--itscare-blue); 
    border: 1px solid rgba(0, 102, 204, 0.3);
}
.cluster-badge.metrocluster { 
    background: rgba(0, 102, 204, 0.2); 
    color: var(--itscare-blue-dark); 
    border: 1px solid rgba(0, 102, 204, 0.4);
}
.cluster-badge.local { 
    background: rgba(106, 106, 106, 0.15); 
    color: var(--text-medium); 
    border: 1px solid rgba(106, 106, 106, 0.3);
}
.cluster-badge.multi-site { 
    background: rgba(0, 102, 204, 0.2); 
    color: var(--itscare-blue-dark); 
    border: 1px solid rgba(0, 102, 204, 0.4);
}
.cluster-badge.single-site { 
    background: rgba(106, 106, 106, 0.15); 
    color: var(--text-medium); 
    border: 1px solid rgba(106, 106, 106, 0.3);
}

.tag-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 500;
    background: rgba(0, 152, 219, 0.12);
    color: var(--itscare-blue);
    border: 1px solid rgba(0, 152, 219, 0.3);
    margin: 0.1rem 0.1rem 0 0;
    white-space: nowrap;
}

.system-tags {
    margin-top: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.1rem;
}

.system-ip {
    color: var(--text-light);
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    font-family: 'Courier New', monospace;
}

.system-version {
    color: var(--itscare-blue);
    font-size: 0.7rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.7rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.status-online { 
    background: #10b981; 
    color: white; 
    border: 1px solid #059669;
}
.status-error { 
    background: #ef4444; 
    color: white; 
    border: 1px solid #dc2626;
}
.status-offline { 
    background: #6b7280; 
    color: white; 
    border: 1px solid #4b5563;
}
.status-warning { 
    background: #f59e0b; 
    color: white; 
    border: 1px solid #d97706;
}
.status-loading {
    background: #94a3b8;
    color: white;
    border: 1px solid #64748b;
}

.loading-placeholder {
    color: var(--text-light);
    font-style: italic;
    font-size: 0.8rem;
    padding: 0.5rem 0;
    text-align: center;
}

@keyframes pulse-loading {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.system-card[data-status="loading"] {
    opacity: 0.8;
}

.system-card[data-status="loading"] .loading-placeholder {
    animation: pulse-loading 1.5s ease-in-out infinite;
}

.metrics {
    margin-top: 0.6rem;
}

.metric {
    display: flex;
    justify-content: space-between;
    padding: 0.3rem 0;
    font-size: 0.75rem;
    border-bottom: 1px solid var(--bg-light);
}

.metric:last-child {
    border-bottom: none;
}

.metric-label {
    color: var(--text-light);
    font-weight: 500;
}

.metric-value {
    font-weight: 600;
    color: var(--text-dark);
}

.metric-ok { color: #27ae60; }
.metric-warning { color: var(--warning); }
.metric-error { color: var(--itscare-red); }

.capacity-bar {
    width: 100%;
    height: 6px;
    background: var(--bg-light);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.capacity-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--itscare-blue) 0%, var(--itscare-blue-light) 100%);
    transition: width 0.3s ease;
}

.capacity-fill.high {
    background: linear-gradient(90deg, var(--warning) 0%, #FF8C00 100%);
}

.capacity-fill.critical {
    background: linear-gradient(90deg, var(--itscare-red) 0%, var(--itscare-red-dark) 100%);
}

.capacity-text {
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 0.25rem;
    font-weight: 500;
}

/* Table View */
.systems-table {
    display: none;
    width: 100%;
    background: var(--bg-white);
    border-radius: 0 0 6px 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
    overflow: hidden;
}

.systems-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    table-layout: fixed;
}

.systems-table thead {
    background: linear-gradient(135deg, var(--itscare-blue) 0%, var(--itscare-blue-dark) 100%);
    color: white;
}

.systems-table th {
    padding: 0.75rem 0.6rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
}

.systems-table td {
    padding: 0.75rem 0.6rem;
    border-bottom: 1px solid var(--bg-light);
}

.systems-table tbody tr {
    transition: background 0.2s;
}

.systems-table tbody tr:hover {
    background: rgba(0, 102, 204, 0.05);
}

.systems-table .status-cell {
    text-align: center;
}

.systems-table .capacity-cell {
}

/* Column text overflow handling for fixed-layout table */
.systems-table th,
.systems-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.systems-table .capacity-cell,
.systems-table td:nth-child(10) {
    white-space: normal;
}

.error-message {
    background: rgba(227, 6, 19, 0.1);
    color: var(--itscare-red);
    padding: 0.5rem;
    border-radius: 4px;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    border: 1px solid rgba(227, 6, 19, 0.2);
}

.no-systems {
    text-align: center;
    padding: 3rem;
    color: var(--text-medium);
    background: var(--bg-white);
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
}

.no-systems h3 {
    color: var(--itscare-blue);
}

.no-systems a {
    color: var(--itscare-red);
    text-decoration: none;
    font-weight: 600;
}

.no-systems a:hover {
    text-decoration: underline;
}

/* View Toggle */
body.table-view .systems-grid {
    display: none;
}

body.table-view .systems-table {
    display: block;
}

/* Node/Site Info */
.node-info {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 0.25rem;
    font-weight: 500;
}

/* ITscare Branding */
.dashboard-footer {
    text-align: center;
    padding: 1rem;
    color: var(--text-light);
    font-size: 0.8rem;
    margin-top: 1rem;
}

.dashboard-footer a {
    color: var(--itscare-blue);
    text-decoration: none;
    font-weight: 600;
}

.dashboard-footer a:hover {
    color: var(--itscare-red);
}

/* Filter Section within Overview Card */
.filter-section {
    padding-bottom: 0;
    border-bottom: none;
}

.filter-section h3 {
    display: none; /* Hide the filter heading */
}

.overview-content {
    padding: 1rem 1.5rem;
}

.controls-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.filter-bar {
    background: var(--bg-white);
    padding: 1rem 1.5rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    border-bottom: 3px solid var(--itscare-green);  /* Solid green line */
}

.filter-bar h3 {
    font-size: 1rem;
    color: var(--itscare-blue);
    margin: 0 0 0.75rem 0;
    font-weight: 600;
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: flex-end;
    flex: 1;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.filter-group label {
    font-size: 0.75rem;
    color: var(--text-medium);
    font-weight: 600;
}

.filter-group select,
.filter-group input {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
    color: var(--text-dark);
    min-width: 130px;
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: var(--itscare-blue);
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
}

/* Custom Tag Dropdown */
.tag-dropdown {
    position: relative;
    min-width: 160px;
}

.tag-dropdown-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
    color: var(--text-dark);
    cursor: pointer;
    width: 100%;
    min-width: 160px;
}

.tag-dropdown-btn:focus {
    outline: none;
    border-color: var(--itscare-blue);
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
}

.tag-dropdown-arrow {
    font-size: 0.7em;
    color: var(--text-medium);
    transition: transform 0.2s;
}

.tag-dropdown.open .tag-dropdown-arrow {
    transform: rotate(180deg);
}

.tag-dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 2px);
    left: 0;
    min-width: 200px;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 200;
    max-height: 280px;
    overflow-y: auto;
}

.tag-dropdown.open .tag-dropdown-menu {
    display: block;
}

.tag-dropdown-group-label {
    padding: 0.3rem 0.75rem;
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--bg-light);
}

.tag-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--text-dark);
    transition: background 0.15s;
}

.tag-dropdown-item:hover {
    background: rgba(0, 102, 204, 0.05);
}

.tag-dropdown-item input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
}

.filter-results {
    color: var(--text-medium);
    font-size: 0.85rem;
    padding: 0.4rem 0;
    font-weight: 600;
}

.btn-reset {
    background: var(--text-light);
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s;
    align-self: flex-end;
    height: fit-content;
}

.actions-section {
    padding-top: 0;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-wrap: nowrap;
    gap: 0.75rem;
}

.actions-section h3 {
    display: none; /* Hide actions heading */
}

.btn-reset:hover {
    background: var(--text-medium);
}

/* WebUI Links */
.webui-link {
    color: inherit;
    text-decoration: none;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.webui-link:hover {
    color: var(--itscare-blue);
    text-shadow: 0 0 10px rgba(0, 102, 204, 0.3);
}

.webui-link-icon {
    font-size: 0.85em;
    opacity: 0.7;
}

.detail-btn {
    background: var(--itscare-blue);
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
    font-weight: 600;
}

.detail-btn:hover {
    background: var(--itscare-blue-dark);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
}

.card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.spinner {
    border: 4px solid rgba(0, 152, 219, 0.2);
    border-top: 4px solid var(--itscare-blue);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: var(--itscare-blue);
    font-size: 1.1rem;
    font-weight: 500;
}

/* Dashboard content - initially hidden */
.dashboard-content {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.dashboard-content.loaded {
    opacity: 1;
}

{% endblock %}

{% block content %}

<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Dashboard wird geladen...</div>
    </div>
</div>

<div class="dashboard-content" id="dashboard-content">
<!-- Combined Overview Card with Filters and Actions -->
<div class="overview-card">
    <div class="overview-header">
        <h2>Storage Systems Overview</h2>
    </div>
    
    <div class="overview-content">
        <div class="controls-wrapper">
            <!-- Filter Section -->
            <div class="filter-section">
                <h3>üîç Filter</h3>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="vendor-filter">Hersteller</label>
                        <select id="vendor-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="pure">Pure Storage</option>
                            <option value="netapp-ontap">NetApp ONTAP</option>
                            <option value="netapp-storagegrid">NetApp StorageGRID</option>
                            <option value="dell-datadomain">Dell DataDomain</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter">Status</label>
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="online">Healthy (Online)</option>
                            <option value="error">Unhealthy (Error)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="cluster-filter">Cluster-Typ</label>
                        <select id="cluster-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="ha">HA</option>
                            <option value="active-cluster">Active-Cluster</option>
                            <option value="metrocluster">MetroCluster</option>
                            <option value="local">Local</option>
                            <option value="multi-site">Multi-Site</option>
                            <option value="single-site">Single-Site</option>
                        </select>
                    </div>
                    {% if tag_groups %}
                    <div class="filter-group">
                        <label>Tags</label>
                        <div class="tag-dropdown" id="tag-dropdown">
                            <button type="button" class="tag-dropdown-btn" id="tag-dropdown-btn" onclick="toggleTagDropdown(event)">
                                <span id="tag-dropdown-label">Alle Tags</span>
                                <span class="tag-dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="tag-dropdown-menu" id="tag-dropdown-menu">
                                {% for group in tag_groups %}
                                <div>
                                    <div class="tag-dropdown-group-label">{{ group.name }}</div>
                                    {% for tag in group.tags.order_by('name') %}
                                     <label class="tag-dropdown-item">
                                        <input type="checkbox" name="tag-filter" value="{{ tag.id }}" data-tag-name="{{ tag.name }}" onchange="handleTagChange()">
                                        {{ tag.name }}
                                    </label>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="filter-group">
                        <label for="search-filter">Suche</label>
                        <input type="text" id="search-filter" placeholder="Name, IP, DNS..." oninput="applyFilters()">
                    </div>
                    <button class="btn-reset" onclick="resetFilters()">Zur√ºcksetzen</button>
                    <div class="filter-results" id="filter-results"></div>
                </div>
            </div>
            
            <!-- Actions Section -->
            <div class="actions-section">
                <h3>Dashboard Optionen</h3>
                <div class="header-actions">
                    <div class="auto-refresh-control">
                        <label class="auto-refresh-label">
                            <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                            <span>Auto-Refresh</span>
                        </label>
                        <select id="refresh-interval" onchange="changeRefreshInterval()">
                            <option value="30">30s</option>
                            <option value="45">45s</option>
                            <option value="60">60s</option>
                            <option value="90">90s</option>
                            <option value="120">2min</option>
                        </select>
                        <span class="refresh-timer" id="refresh-timer"></span>
                    </div>
                    <div class="view-toggle">
                        <button id="card-view-btn" class="active" onclick="switchView('card')">
                            <span>&#x25A0;&#x25A0;</span> Cards
                        </button>
                        <button id="table-view-btn" onclick="switchView('table')">
                            <span>‚ò∞</span> Table
                        </button>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">&#x21bb; Aktualisieren</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not grouped_systems %}
<div class="no-systems">
    <h3>Keine Storage Systeme konfiguriert</h3>
    <p>F√ºgen Sie Storage Systeme im <a href="/admin">Admin-Bereich</a> hinzu.</p>
</div>
{% else %}
    {% for vendor in vendor_order %}
    {% if vendor in grouped_systems %}
    {% set systems = grouped_systems[vendor] %}
    <div class="vendor-section">
        <div class="vendor-header">
            <span>{{ vendor_names[vendor] }}</span>
            <span class="vendor-count">{{ systems|length }} System{{ 'e' if systems|length != 1 else '' }}</span>
        </div>
        
        <!-- Card View -->
        <div class="systems-grid">
            {% for item in systems %}
            {% set system = item.system %}
            {% set status = item.status %}
            {% set dns_names = system.dns_names %}
            <div class="system-card" 
                 data-system-id="{{ system.id }}"
                 data-vendor="{{ vendor }}" 
                 data-status="{{ status.status if status else 'loading' }}"
                 data-cluster-type="{{ system.cluster_type or '' }}"
                 data-name="{{ system.name }}"
                 data-ip="{{ system.ip_address }}"
                 data-dns="{{ dns_names[0] if dns_names else '' }}"
                 data-tags="{{ system.tags | map(attribute='id') | join(',') if system.tags else '' }}">
                <div class="system-header">
                    <div class="system-name">
                        <a href="https://{% if dns_names %}{{ dns_names[0] }}{% else %}{{ system.ip_address }}{% endif %}" target="_blank" rel="noopener noreferrer" 
                           class="webui-link" title="Zur WebUI √∂ffnen">
                            {{ system.name }}
                            <span class="webui-link-icon">‚Üó</span>
                        </a>
                    </div>
                    {% if system.cluster_type %}
                    <span class="cluster-badge {{ system.cluster_type }}">
                        {% if system.cluster_type == 'ha' %}HA
                        {% elif system.cluster_type == 'active-cluster' %}Active
                        {% elif system.cluster_type == 'metrocluster' %}Metro
                        {% elif system.cluster_type == 'local' %}Local
                        {% elif system.cluster_type == 'multi-site' %}Multi-Site
                        {% elif system.cluster_type == 'single-site' %}Single
                        {% else %}{{ system.cluster_type }}{% endif %}
                    </span>
                    {% endif %}
                </div>
                <div class="system-ip">{{ system.ip_address }}</div>
                {% if system.os_version %}
                <div class="system-version">{{ system.os_version }}</div>
                {% endif %}
                
                <span class="status-badge status-{{ status.status if status else 'loading' }}">
                    {% if not status %}‚è≥ L√§dt...
                    {% elif status.status == 'online' %}‚úì Online
                    {% elif status.status == 'error' %}‚úó Fehler
                    {% else %}? Unbekannt{% endif %}
                </span>
                
                {% if system.node_count or system.site_count %}
                <div class="node-info">
                    {% if system.node_count %}{{ system.node_count }} Nodes{% endif %}
                    {% if system.node_count and system.site_count %} / {% endif %}
                    {% if system.site_count %}{{ system.site_count }} Sites{% endif %}
                </div>
                {% endif %}
                
                {% if status %}
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">Hardware:</span>
                        <span class="metric-value metric-{{ status.hardware_status }}">
                            {{ status.hardware_status|upper }}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cluster:</span>
                        <span class="metric-value metric-{{ status.cluster_status }}">
                            {{ status.cluster_status|upper }}
                        </span>
                    </div>
                    {% if status.status == 'online' %}
                    <div class="metric">
                        <span class="metric-label">Alerts:</span>
                        <span class="metric-value {% if status.alerts > 0 %}metric-warning{% endif %}">
                            {{ status.alerts }}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Kapazit√§t:</span>
                        <span class="metric-value">
                            {{ "%.1f"|format(status.capacity_used_tb) }} / {{ "%.1f"|format(status.capacity_total_tb) }} TB
                        </span>
                    </div>
                    <div class="capacity-bar">
                        <div class="capacity-fill {% if status.capacity_percent > 90 %}critical{% elif status.capacity_percent > 75 %}high{% endif %}" 
                             style="width: {{ status.capacity_percent }}%"></div>
                    </div>
                    <div class="capacity-text">
                        {{ "%.1f"|format(status.capacity_percent) }}% belegt
                    </div>
                    {% endif %}
                </div>
                
                {% if status.error %}
                <div class="error-message">{{ status.error }}</div>
                {% endif %}
                {% else %}
                <div class="metrics">
                    <div class="loading-placeholder">Daten werden geladen...</div>
                </div>
                {% endif %}
                
                {% if system.tags %}
                <div class="system-tags">
                    {% for tag in system.tags %}
                    <span class="tag-badge" title="{{ tag.group.name if tag.group else '' }}">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="card-actions">
                    <a href="/systems/{{ system.id }}/details" class="detail-btn">üìä Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Table View -->
        <div class="systems-table">
            <table>
                <colgroup>
                    <col style="width: 15%">  <!-- Name -->
                    <col style="width: 10%">  <!-- Cluster-Typ -->
                    <col style="width: 10%">  <!-- IP -->
                    <col style="width: 10%">  <!-- OS Version -->
                    <col style="width: 7%">   <!-- Status -->
                    <col style="width: 8%">   <!-- Hardware -->
                    <col style="width: 8%">   <!-- Cluster -->
                    <col style="width: 6%">   <!-- Alerts -->
                    <col style="width: 14%">  <!-- Kapazit√§t -->
                    <col style="width: 8%">   <!-- Tags -->
                    <col style="width: 4%">   <!-- Aktionen -->
                </colgroup>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Cluster-Typ</th>
                        <th>IP</th>
                        <th>OS Version</th>
                        <th class="status-cell">Status</th>
                        <th>Hardware</th>
                        <th>Cluster</th>
                        <th class="status-cell">Alerts</th>
                        <th class="capacity-cell">Kapazit√§t</th>
                        <th>Tags</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in systems %}
                    {% set system = item.system %}
                    {% set status = item.status %}
                    {% set dns_names = system.dns_names %}
                    <tr data-system-id="{{ system.id }}"
                        data-vendor="{{ vendor }}" 
                        data-status="{{ status.status if status else 'loading' }}"
                        data-cluster-type="{{ system.cluster_type or '' }}"
                        data-name="{{ system.name }}"
                        data-ip="{{ system.ip_address }}"
                        data-dns="{{ dns_names[0] if dns_names else '' }}"
                        data-tags="{{ system.tags | map(attribute='id') | join(',') if system.tags else '' }}">
                        <td>
                            <a href="https://{% if dns_names %}{{ dns_names[0] }}{% else %}{{ system.ip_address }}{% endif %}" target="_blank" rel="noopener noreferrer" 
                               class="webui-link" title="Zur WebUI √∂ffnen" style="font-weight: bold;">
                                {{ system.name }} ‚Üó
                            </a>
                            {% if system.node_count or system.site_count %}
                            <br><small style="color: var(--text-light);">
                                {% if system.node_count %}{{ system.node_count }}N{% endif %}
                                {% if system.site_count %}/{{ system.site_count }}S{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            {% if system.cluster_type %}
                            <span class="cluster-badge {{ system.cluster_type }}">
                                {% if system.cluster_type == 'ha' %}HA
                                {% elif system.cluster_type == 'active-cluster' %}Active-Cluster
                                {% elif system.cluster_type == 'metrocluster' %}MetroCluster
                                {% elif system.cluster_type == 'local' %}Local
                                {% elif system.cluster_type == 'multi-site' %}Multi-Site
                                {% elif system.cluster_type == 'single-site' %}Single-Site
                                {% else %}{{ system.cluster_type }}{% endif %}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td><small style="font-family: 'Courier New', monospace;">{{ system.ip_address }}</small></td>
                        <td><small style="color: var(--itscare-blue); font-weight: 500;">{{ system.os_version or '-' }}</small></td>
                        <td class="status-cell">
                            <span class="status-badge status-{{ status.status if status else 'loading' }}">
                                {% if not status %}‚è≥
                                {% elif status.status == 'online' %}‚úì
                                {% elif status.status == 'error' %}‚úó
                                {% else %}?{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if status %}
                            <span class="metric-value metric-{{ status.hardware_status }}">
                                {{ status.hardware_status|upper }}
                            </span>
                            {% else %}<span class="loading-placeholder">...</span>{% endif %}
                        </td>
                        <td>
                            {% if status %}
                            <span class="metric-value metric-{{ status.cluster_status }}">
                                {{ status.cluster_status|upper }}
                            </span>
                            {% else %}<span class="loading-placeholder">...</span>{% endif %}
                        </td>
                        <td class="status-cell">
                            {% if status and status.status == 'online' %}
                            <span class="{% if status.alerts > 0 %}metric-warning{% endif %}">
                                {{ status.alerts }}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="capacity-cell">
                            {% if status and status.status == 'online' and status.capacity_total_tb > 0 %}
                            <div>
                                <small>{{ "%.1f"|format(status.capacity_used_tb) }} / {{ "%.1f"|format(status.capacity_total_tb) }} TB</small>
                            </div>
                            <div class="capacity-bar">
                                <div class="capacity-fill {% if status.capacity_percent > 90 %}critical{% elif status.capacity_percent > 75 %}high{% endif %}" 
                                     style="width: {{ status.capacity_percent }}%"></div>
                            </div>
                            <div class="capacity-text">{{ "%.1f"|format(status.capacity_percent) }}%</div>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if system.tags %}
                            <div class="system-tags">
                                {% for tag in system.tags %}
                                <span class="tag-badge" title="{{ tag.group.name if tag.group else '' }}">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            <a href="/systems/{{ system.id }}/details" class="detail-btn" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endfor %}
{% endif %}

<div class="dashboard-footer">
    Powered by <a href="https://www.itscare.de" target="_blank">ITscare</a> | Storage Dashboard v1.0
</div>
</div>

<script>
// Polyfill for CSS.escape for older browsers
// Based on https://drafts.csswg.org/cssom/#the-css.escape()-method
if (!CSS.escape) {
    CSS.escape = function(value) {
        if (arguments.length === 0) {
            throw new TypeError('`CSS.escape` requires an argument.');
        }
        var string = String(value);
        var length = string.length;
        var index = -1;
        var codeUnit;
        var result = '';
        var firstCodeUnit = string.charCodeAt(0);
        while (++index < length) {
            codeUnit = string.charCodeAt(index);
            // Note: there's no need to special-case astral symbols, surrogate
            // pairs, or lone surrogates.

            // If the character is NULL (U+0000), replace it with U+FFFD.
            if (codeUnit === 0x0000) {
                result += '\uFFFD';
                continue;
            }

            if (
                // If the character is in the range [\1-\1F] (U+0001 to U+001F) or is
                // U+007F, [‚Ä¶]
                (codeUnit >= 0x0001 && codeUnit <= 0x001F) || codeUnit === 0x007F ||
                // If the character is the first character and is in the range [0-9]
                // (U+0030 to U+0039), [‚Ä¶]
                (index === 0 && codeUnit >= 0x0030 && codeUnit <= 0x0039) ||
                // If the character is the second character and is in the range [0-9]
                // (U+0030 to U+0039) and the first character is a `-` (U+002D), [‚Ä¶]
                (
                    index === 1 &&
                    codeUnit >= 0x0030 && codeUnit <= 0x0039 &&
                    firstCodeUnit === 0x002D
                )
            ) {
                // https://drafts.csswg.org/cssom/#escape-a-character-as-code-point
                result += '\\' + codeUnit.toString(16) + ' ';
                continue;
            }

            if (
                // If the character is the first character and is a `-` (U+002D), and
                // there is no second character, [‚Ä¶]
                index === 0 &&
                length === 1 &&
                codeUnit === 0x002D
            ) {
                result += '\\' + string.charAt(index);
                continue;
            }

            // If the character is not handled by one of the above rules and is
            // greater than or equal to U+0080, is `-` (U+002D) or `_` (U+005F), or
            // is in one of the ranges [0-9] (U+0030 to U+0039), [A-Z] (U+0041 to
            // U+005A), or [a-z] (U+0061 to U+007A), [‚Ä¶]
            if (
                codeUnit >= 0x0080 ||
                codeUnit === 0x002D ||
                codeUnit === 0x005F ||
                codeUnit >= 0x0030 && codeUnit <= 0x0039 ||
                codeUnit >= 0x0041 && codeUnit <= 0x005A ||
                codeUnit >= 0x0061 && codeUnit <= 0x007A
            ) {
                // the character itself
                result += string.charAt(index);
                continue;
            }

            // Otherwise, the escaped character.
            // https://drafts.csswg.org/cssom/#escape-a-character
            result += '\\' + string.charAt(index);
        }
        return result;
    };
}

// Auto-refresh configuration
const DEFAULT_REFRESH_INTERVAL = '45';  // Default refresh interval in seconds
let autoRefreshCountdown = null;
let refreshTimeSeconds = 45;
let countdownSeconds = refreshTimeSeconds;

// Initialize auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if async loading is enabled
    const asyncLoad = {{ async_load|tojson|safe }};
    
    if (asyncLoad) {
        // Load data asynchronously
        loadDashboardData();
    } else {
        // Hide loading overlay and show content (sync mode)
        const loadingOverlay = document.getElementById('loading-overlay');
        const dashboardContent = document.getElementById('dashboard-content');
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
        if (dashboardContent) {
            dashboardContent.classList.add('loaded');
        }
    }
    
    const savedView = localStorage.getItem('dashboard-view') || 'card';
    switchView(savedView);
    applyFilters(); // Apply initial filters
    
    // Restore refresh interval preference
    const savedInterval = localStorage.getItem('refresh-interval') || DEFAULT_REFRESH_INTERVAL;
    refreshTimeSeconds = parseInt(savedInterval, 10);
    document.getElementById('refresh-interval').value = savedInterval;
    
    // Restore auto-refresh preference
    const autoRefreshEnabled = localStorage.getItem('auto-refresh-enabled') === 'true';
    document.getElementById('auto-refresh-toggle').checked = autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        startAutoRefresh();
    } else {
        updateTimerDisplay();
    }
});

// Load dashboard data asynchronously
function loadDashboardData() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update each system card with the fetched status
            data.forEach(item => {
                updateSystemCard(item.system, item.status);
                updateSystemTableRow(item.system, item.status);
            });
            
            // Hide loading overlay and show content
            const loadingOverlay = document.getElementById('loading-overlay');
            const dashboardContent = document.getElementById('dashboard-content');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.add('loaded');
            }
            
            // Reapply filters after data load
            applyFilters();
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            // Hide loading overlay even on error
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
            const dashboardContent = document.getElementById('dashboard-content');
            if (dashboardContent) {
                dashboardContent.classList.add('loaded');
            }
        });
}

// Update a single system card with new status data
function updateSystemCard(system, status) {
    const card = document.querySelector(`.system-card[data-system-id="${CSS.escape(String(system.id))}"]`);
    if (!card) return;
    
    // Update data attributes
    card.setAttribute('data-status', status.status || 'unknown');
    
    // Update status badge
    const statusBadge = card.querySelector('.status-badge');
    if (statusBadge) {
        statusBadge.className = `status-badge status-${status.status || 'unknown'}`;
        if (status.status === 'online') {
            statusBadge.textContent = '‚úì Online';
        } else if (status.status === 'error') {
            statusBadge.textContent = '‚úó Fehler';
        } else {
            statusBadge.textContent = '? Unbekannt';
        }
    }
    
    // Update metrics section
    const metricsDiv = card.querySelector('.metrics');
    if (metricsDiv) {
        let metricsHTML = '';
        
        // Hardware status
        metricsHTML += `
            <div class="metric">
                <span class="metric-label">Hardware:</span>
                <span class="metric-value metric-${status.hardware_status || 'unknown'}">
                    ${(status.hardware_status || 'UNKNOWN').toUpperCase()}
                </span>
            </div>`;
        
        // Cluster status
        metricsHTML += `
            <div class="metric">
                <span class="metric-label">Cluster:</span>
                <span class="metric-value metric-${status.cluster_status || 'unknown'}">
                    ${(status.cluster_status || 'UNKNOWN').toUpperCase()}
                </span>
            </div>`;
        
        // Online-specific metrics
        if (status.status === 'online') {
            metricsHTML += `
                <div class="metric">
                    <span class="metric-label">Alerts:</span>
                    <span class="metric-value ${status.alerts > 0 ? 'metric-warning' : ''}">
                        ${status.alerts || 0}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Kapazit√§t:</span>
                    <span class="metric-value">
                        ${(status.capacity_used_tb || 0).toFixed(1)} / ${(status.capacity_total_tb || 0).toFixed(1)} TB
                    </span>
                </div>`;
            
            // Capacity bar
            const capacityPercent = status.capacity_percent || 0;
            let fillClass = '';
            if (capacityPercent > 90) fillClass = 'critical';
            else if (capacityPercent > 75) fillClass = 'high';
            
            metricsHTML += `
                <div class="capacity-bar">
                    <div class="capacity-fill ${fillClass}" style="width: ${capacityPercent}%"></div>
                </div>
                <div class="capacity-text">
                    ${capacityPercent.toFixed(1)}% belegt
                </div>`;
        }
        
        metricsDiv.innerHTML = metricsHTML;
    }
    
    // Handle error message
    let errorDiv = card.querySelector('.error-message');
    if (status.error) {
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            const cardActions = card.querySelector('.card-actions');
            if (cardActions) {
                cardActions.parentNode.insertBefore(errorDiv, cardActions);
            }
        }
        errorDiv.textContent = status.error;
    } else if (errorDiv) {
        errorDiv.remove();
    }
}

// Update a single system table row with new status data
function updateSystemTableRow(system, status) {
    const row = document.querySelector(`tr[data-system-id="${CSS.escape(String(system.id))}"]`);
    if (!row) return;
    
    // Update data attributes
    row.setAttribute('data-status', status.status || 'unknown');
    
    const cells = row.querySelectorAll('td');
    if (cells.length < 10) return;
    
    // Update status badge (cell 4)
    const statusCell = cells[4];
    if (statusCell) {
        const statusBadge = statusCell.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.className = `status-badge status-${status.status || 'unknown'}`;
            if (status.status === 'online') {
                statusBadge.textContent = '‚úì';
            } else if (status.status === 'error') {
                statusBadge.textContent = '‚úó';
            } else {
                statusBadge.textContent = '?';
            }
        }
    }
    
    // Update hardware status (cell 5)
    const hwCell = cells[5];
    if (hwCell) {
        hwCell.innerHTML = `<span class="metric-value metric-${status.hardware_status || 'unknown'}">
            ${(status.hardware_status || 'UNKNOWN').toUpperCase()}
        </span>`;
    }
    
    // Update cluster status (cell 6)
    const clusterCell = cells[6];
    if (clusterCell) {
        clusterCell.innerHTML = `<span class="metric-value metric-${status.cluster_status || 'unknown'}">
            ${(status.cluster_status || 'UNKNOWN').toUpperCase()}
        </span>`;
    }
    
    // Update alerts (cell 7)
    const alertsCell = cells[7];
    if (alertsCell && status.status === 'online') {
        alertsCell.innerHTML = `<span class="${status.alerts > 0 ? 'metric-warning' : ''}">
            ${status.alerts || 0}
        </span>`;
    } else if (alertsCell) {
        alertsCell.textContent = '-';
    }
    
    // Update capacity (cell 8)
    const capacityCell = cells[8];
    if (capacityCell && status.status === 'online' && status.capacity_total_tb > 0) {
        const capacityPercent = status.capacity_percent || 0;
        let fillClass = '';
        if (capacityPercent > 90) fillClass = 'critical';
        else if (capacityPercent > 75) fillClass = 'high';
        
        capacityCell.innerHTML = `
            <div>
                <small>${(status.capacity_used_tb || 0).toFixed(1)} / ${(status.capacity_total_tb || 0).toFixed(1)} TB</small>
            </div>
            <div class="capacity-bar">
                <div class="capacity-fill ${fillClass}" style="width: ${capacityPercent}%"></div>
            </div>
            <div class="capacity-text">${capacityPercent.toFixed(1)}%</div>`;
    } else if (capacityCell) {
        capacityCell.textContent = '-';
    }
}

function changeRefreshInterval() {
    const newInterval = parseInt(document.getElementById('refresh-interval').value, 10);
    refreshTimeSeconds = newInterval;
    localStorage.setItem('refresh-interval', newInterval);
    
    // If auto-refresh is active, restart with new interval
    if (document.getElementById('auto-refresh-toggle').checked) {
        startAutoRefresh();
    }
}

function toggleAutoRefresh() {
    const isEnabled = document.getElementById('auto-refresh-toggle').checked;
    localStorage.setItem('auto-refresh-enabled', isEnabled);
    
    if (isEnabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    // Clear any existing intervals
    stopAutoRefresh();
    
    // Reset countdown
    countdownSeconds = refreshTimeSeconds;
    updateTimerDisplay();
    
    // Start countdown timer (updates every second)
    autoRefreshCountdown = setInterval(function() {
        countdownSeconds--;
        updateTimerDisplay();
        
        // Trigger refresh when countdown reaches zero
        if (countdownSeconds <= 0) {
            refreshDashboard();
            return; // Exit early as refreshDashboard will reload the page
        }
    }, 1000);
}

function stopAutoRefresh() {
    if (autoRefreshCountdown) {
        clearInterval(autoRefreshCountdown);
        autoRefreshCountdown = null;
    }
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('refresh-timer');
    const isEnabled = document.getElementById('auto-refresh-toggle').checked;
    
    if (isEnabled) {
        timerElement.textContent = `${countdownSeconds}s`;
        timerElement.classList.remove('refreshing');
    } else {
        timerElement.textContent = '';
        timerElement.classList.remove('refreshing');
    }
}

function refreshDashboard() {
    const timerElement = document.getElementById('refresh-timer');
    timerElement.textContent = 'L√§dt...';
    timerElement.classList.add('refreshing');
    
    // Use async data loading instead of full page reload
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update each system card with the fetched status
            data.forEach(item => {
                updateSystemCard(item.system, item.status);
                updateSystemTableRow(item.system, item.status);
            });
            
            // Reapply filters after data load
            applyFilters();
            
            // Restart auto-refresh countdown if enabled
            const isEnabled = document.getElementById('auto-refresh-toggle').checked;
            if (isEnabled) {
                startAutoRefresh();
            } else {
                timerElement.textContent = '';
                timerElement.classList.remove('refreshing');
            }
        })
        .catch(error => {
            console.error('Error refreshing dashboard:', error);
            timerElement.textContent = 'Fehler';
            timerElement.classList.remove('refreshing');
            
            // Retry with auto-refresh if enabled
            const isEnabled = document.getElementById('auto-refresh-toggle').checked;
            if (isEnabled) {
                setTimeout(() => startAutoRefresh(), 5000);
            }
        });
}

function manualRefresh() {
    // Use async refresh instead of full page reload
    refreshDashboard();
}

// View switching with localStorage persistence
function switchView(view) {
    const cardBtn = document.getElementById('card-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    
    if (view === 'card') {
        document.body.classList.remove('table-view');
        cardBtn.classList.add('active');
        tableBtn.classList.remove('active');
    } else {
        document.body.classList.add('table-view');
        tableBtn.classList.add('active');
        cardBtn.classList.remove('active');
    }
    
    // Save preference
    localStorage.setItem('dashboard-view', view);
}

// Tag dropdown helpers
function handleTagChange() {
    applyFilters();
    updateTagDropdownLabel();
}

function toggleTagDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('tag-dropdown');
    if (dropdown) dropdown.classList.toggle('open');
}

function updateTagDropdownLabel() {
    const checked = document.querySelectorAll('#tag-dropdown-menu input[type="checkbox"]:checked');
    const label = document.getElementById('tag-dropdown-label');
    if (!label) return;
    if (checked.length === 0) {
        label.textContent = 'Alle Tags';
    } else if (checked.length === 1) {
        label.textContent = checked[0].dataset.tagName || checked[0].value;
    } else {
        label.textContent = checked.length + ' Tags';
    }
}

document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('tag-dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// Filter logic
function applyFilters() {
    const vendorFilter = document.getElementById('vendor-filter').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value.toLowerCase();
    const clusterFilter = document.getElementById('cluster-filter').value.toLowerCase();
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    // Collect selected tag IDs (checkbox dropdown)
    const tagCheckboxes = document.querySelectorAll('#tag-dropdown-menu input[type="checkbox"]:checked');
    const selectedTagIds = Array.from(tagCheckboxes).map(cb => cb.value);
    
    // Get all system cards and table rows
    const systemCards = document.querySelectorAll('.system-card');
    const tableRows = document.querySelectorAll('.systems-table tbody tr');
    
    let visibleCount = 0;
    let totalCount = systemCards.length;
    
    // Filter cards
    systemCards.forEach(card => {
        const vendor = card.dataset.vendor || '';
        const status = card.dataset.status || '';
        const clusterType = card.dataset.clusterType || '';
        const name = card.dataset.name || '';
        const ip = card.dataset.ip || '';
        const dns = card.dataset.dns || '';
        const cardTags = card.dataset.tags ? card.dataset.tags.split(',') : [];
        
        const matchVendor = !vendorFilter || vendor.includes(vendorFilter);
        const matchStatus = !statusFilter || status === statusFilter;
        const matchCluster = !clusterFilter || clusterType === clusterFilter;
        const matchSearch = !searchFilter || 
            name.toLowerCase().includes(searchFilter) ||
            ip.includes(searchFilter) ||
            dns.toLowerCase().includes(searchFilter);
        const matchTags = selectedTagIds.length === 0 ||
            selectedTagIds.every(id => cardTags.includes(id));
        
        if (matchVendor && matchStatus && matchCluster && matchSearch && matchTags) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Filter table rows
    tableRows.forEach(row => {
        const vendor = row.dataset.vendor || '';
        const status = row.dataset.status || '';
        const clusterType = row.dataset.clusterType || '';
        const name = row.dataset.name || '';
        const ip = row.dataset.ip || '';
        const dns = row.dataset.dns || '';
        const rowTags = row.dataset.tags ? row.dataset.tags.split(',') : [];
        
        const matchVendor = !vendorFilter || vendor.includes(vendorFilter);
        const matchStatus = !statusFilter || status === statusFilter;
        const matchCluster = !clusterFilter || clusterType === clusterFilter;
        const matchSearch = !searchFilter || 
            name.toLowerCase().includes(searchFilter) ||
            ip.includes(searchFilter) ||
            dns.toLowerCase().includes(searchFilter);
        const matchTags = selectedTagIds.length === 0 ||
            selectedTagIds.every(id => rowTags.includes(id));
        
        if (matchVendor && matchStatus && matchCluster && matchSearch && matchTags) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update filter results
    const resultsDiv = document.getElementById('filter-results');
    resultsDiv.textContent = `${visibleCount} von ${totalCount} Systemen angezeigt`;
    
    // Show/hide vendor sections if all items are hidden
    document.querySelectorAll('.vendor-section').forEach(section => {
        const visibleCards = section.querySelectorAll('.system-card:not([style*="display: none"])');
        const visibleRows = section.querySelectorAll('.systems-table tbody tr:not([style*="display: none"])');
        
        if (visibleCards.length === 0 && visibleRows.length === 0) {
            section.style.display = 'none';
        } else {
            section.style.display = '';
        }
    });
}

// Reset filters
function resetFilters() {
    document.getElementById('vendor-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('cluster-filter').value = '';
    document.getElementById('search-filter').value = '';
    document.querySelectorAll('#tag-dropdown-menu input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateTagDropdownLabel();
    applyFilters();
}
</script>
{% endblock %}
