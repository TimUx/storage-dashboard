{% extends "base.html" %}

{% block title %}Storage Dashboard - ITscare{% endblock %}

{% block styles %}
/* ITscare Corporate Design - Full HD Optimization (1920x1080) */
:root {
    /* ITscare Primary Colors from Logo */
    --itscare-blue: #0066CC;
    --itscare-blue-dark: #004C99;
    --itscare-blue-light: #3385D6;
    --itscare-red: #E30613;
    --itscare-red-dark: #B30510;
    --itscare-green: #00A651;
    --itscare-green-dark: #008040;
    
    /* UI Colors */
    --text-dark: #1a1a1a;
    --text-medium: #4a4a4a;
    --text-light: #6a6a6a;
    --bg-light: #f5f7fa;
    --bg-white: #ffffff;
    --border-light: #e1e8ed;
    --warning: #FFA500;
}

body {
    font-size: 14px;
    background: var(--bg-light);
}

.container {
    width: 100%;
    margin: 0;
    padding: 0.75rem;
}

/* Combined Overview Card */
.overview-card {
    background: var(--bg-white);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    margin: 0.5rem 0 1rem 0;
    overflow: hidden;
    border-bottom: 4px solid;
    border-image: linear-gradient(90deg, var(--itscare-blue) 0%, var(--itscare-blue) 33.33%, var(--itscare-green) 33.33%, var(--itscare-green) 66.66%, var(--itscare-red) 66.66%, var(--itscare-red) 100%) 1;
}

.overview-header {
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-light);
}

.overview-header h2 {
    font-size: 1.5rem;
    color: var(--itscare-blue);
    margin: 0;
    font-weight: 600;
}

.overview-content {
    padding: 1rem 1.5rem;
}

.dashboard-header {
    margin: 0.5rem 0 1rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-white);
    padding: 1rem 1.5rem;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    border-left: 4px solid var(--itscare-blue);
}

.dashboard-header h2 {
    font-size: 1.5rem;
    color: var(--itscare-blue);
    margin: 0;
    font-weight: 600;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.auto-refresh-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-light);
    border-radius: 6px;
    border: 1px solid var(--border-light);
}

.auto-refresh-control select {
    padding: 0.3rem 0.5rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
    color: var(--text-dark);
}

.auto-refresh-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-medium);
    font-weight: 500;
    user-select: none;
}

.auto-refresh-label input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--itscare-green);
}

.refresh-timer {
    font-size: 0.85rem;
    color: var(--itscare-blue);
    font-weight: 600;
    min-width: 80px;
    text-align: right;
}

.refresh-timer.refreshing {
    color: var(--itscare-green);
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.view-toggle {
    display: flex;
    background: var(--bg-light);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border-light);
}

.view-toggle button {
    background: transparent;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-medium);
    transition: all 0.3s;
    font-weight: 500;
}

.view-toggle button:hover {
    background: rgba(0, 102, 204, 0.1);
}

.view-toggle button.active {
    background: var(--itscare-blue);
    color: white;
}

.refresh-btn {
    background: var(--itscare-blue);
    color: white;
    border: none;
    padding: 0.5rem 1.25rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2);
}

.refresh-btn:hover {
    background: var(--itscare-blue-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
}

.vendor-section {
    margin: 0.75rem 0;
}

.vendor-header {
    background: white;
    color: var(--itscare-blue);
    padding: 0.75rem 1.25rem;
    border-radius: 6px 6px 0 0;
    font-size: 1.05rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
    border-bottom: 4px solid;
    border-image: linear-gradient(90deg, var(--itscare-blue) 0%, var(--itscare-blue) 33.33%, var(--itscare-green) 33.33%, var(--itscare-green) 66.66%, var(--itscare-red) 66.66%, var(--itscare-red) 100%) 1;
}

.vendor-count {
    font-size: 0.85rem;
    opacity: 0.7;
    font-weight: 400;
    color: var(--text-medium);
}

/* Card View - Optimized for 25 systems on Full HD */
.systems-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-white);
    border-radius: 0 0 6px 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
}

.system-card {
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 0.85rem;
    background: var(--bg-white);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
}

.system-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--itscare-blue) 0%, var(--itscare-green) 50%, var(--itscare-red) 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.system-card:hover::before {
    transform: scaleX(1);
}

.system-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 102, 204, 0.15);
    border-color: var(--itscare-blue);
}

.system-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.system-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-dark);
    line-height: 1.3;
    flex: 1;
}

.cluster-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    white-space: nowrap;
    margin-left: 0.25rem;
}

.cluster-badge.ha { 
    background: rgba(0, 166, 81, 0.15); 
    color: var(--itscare-green); 
    border: 1px solid rgba(0, 166, 81, 0.3);
}
.cluster-badge.active-cluster { 
    background: rgba(0, 102, 204, 0.15); 
    color: var(--itscare-blue); 
    border: 1px solid rgba(0, 102, 204, 0.3);
}
.cluster-badge.metrocluster { 
    background: rgba(0, 102, 204, 0.2); 
    color: var(--itscare-blue-dark); 
    border: 1px solid rgba(0, 102, 204, 0.4);
}
.cluster-badge.local { 
    background: rgba(106, 106, 106, 0.15); 
    color: var(--text-medium); 
    border: 1px solid rgba(106, 106, 106, 0.3);
}
.cluster-badge.multi-site { 
    background: rgba(227, 6, 19, 0.15); 
    color: var(--itscare-red); 
    border: 1px solid rgba(227, 6, 19, 0.3);
}
.cluster-badge.single-site { 
    background: rgba(106, 106, 106, 0.15); 
    color: var(--text-medium); 
    border: 1px solid rgba(106, 106, 106, 0.3);
}

.system-ip {
    color: var(--text-light);
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    font-family: 'Courier New', monospace;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.7rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.status-online { 
    background: rgba(0, 166, 81, 0.15); 
    color: var(--itscare-green); 
    border: 1px solid rgba(0, 166, 81, 0.3);
}
.status-error { 
    background: rgba(227, 6, 19, 0.15); 
    color: var(--itscare-red); 
    border: 1px solid rgba(227, 6, 19, 0.3);
}
.status-offline { 
    background: rgba(106, 106, 106, 0.15); 
    color: var(--text-medium); 
    border: 1px solid rgba(106, 106, 106, 0.3);
}
.status-warning { 
    background: rgba(255, 165, 0, 0.15); 
    color: var(--warning); 
    border: 1px solid rgba(255, 165, 0, 0.3);
}

.metrics {
    margin-top: 0.6rem;
}

.metric {
    display: flex;
    justify-content: space-between;
    padding: 0.3rem 0;
    font-size: 0.75rem;
    border-bottom: 1px solid var(--bg-light);
}

.metric:last-child {
    border-bottom: none;
}

.metric-label {
    color: var(--text-light);
    font-weight: 500;
}

.metric-value {
    font-weight: 600;
    color: var(--text-dark);
}

.metric-ok { color: var(--itscare-green); }
.metric-warning { color: var(--warning); }
.metric-error { color: var(--itscare-red); }

.capacity-bar {
    width: 100%;
    height: 6px;
    background: var(--bg-light);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.capacity-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--itscare-blue) 0%, var(--itscare-blue-light) 100%);
    transition: width 0.3s ease;
}

.capacity-fill.high {
    background: linear-gradient(90deg, var(--warning) 0%, #FF8C00 100%);
}

.capacity-fill.critical {
    background: linear-gradient(90deg, var(--itscare-red) 0%, var(--itscare-red-dark) 100%);
}

.capacity-text {
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 0.25rem;
    font-weight: 500;
}

/* Table View */
.systems-table {
    display: none;
    width: 100%;
    background: var(--bg-white);
    border-radius: 0 0 6px 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
    overflow: hidden;
}

.systems-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.systems-table thead {
    background: linear-gradient(135deg, var(--itscare-blue) 0%, var(--itscare-blue-dark) 100%);
    color: white;
}

.systems-table th {
    padding: 0.75rem 0.6rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
}

.systems-table td {
    padding: 0.75rem 0.6rem;
    border-bottom: 1px solid var(--bg-light);
}

.systems-table tbody tr {
    transition: background 0.2s;
}

.systems-table tbody tr:hover {
    background: rgba(0, 102, 204, 0.05);
}

.systems-table .status-cell {
    text-align: center;
}

.systems-table .capacity-cell {
    min-width: 150px;
}

.error-message {
    background: rgba(227, 6, 19, 0.1);
    color: var(--itscare-red);
    padding: 0.5rem;
    border-radius: 4px;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    border: 1px solid rgba(227, 6, 19, 0.2);
}

.no-systems {
    text-align: center;
    padding: 3rem;
    color: var(--text-medium);
    background: var(--bg-white);
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 102, 204, 0.08);
}

.no-systems h3 {
    color: var(--itscare-blue);
}

.no-systems a {
    color: var(--itscare-red);
    text-decoration: none;
    font-weight: 600;
}

.no-systems a:hover {
    text-decoration: underline;
}

/* View Toggle */
body.table-view .systems-grid {
    display: none;
}

body.table-view .systems-table {
    display: block;
}

/* Node/Site Info */
.node-info {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 0.25rem;
    font-weight: 500;
}

/* ITscare Branding */
.dashboard-footer {
    text-align: center;
    padding: 1rem;
    color: var(--text-light);
    font-size: 0.8rem;
    margin-top: 1rem;
}

.dashboard-footer a {
    color: var(--itscare-blue);
    text-decoration: none;
    font-weight: 600;
}

.dashboard-footer a:hover {
    color: var(--itscare-red);
}

/* Filter Section within Overview Card */
.filter-section {
    padding-bottom: 0;
    border-bottom: none;
}

.filter-section h3 {
    display: none; /* Hide the filter heading */
}

.overview-content {
    padding: 1rem 1.5rem;
}

.controls-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.filter-bar {
    background: var(--bg-white);
    padding: 1rem 1.5rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
    border-left: 4px solid var(--itscare-green);
}

.filter-bar h3 {
    font-size: 1rem;
    color: var(--itscare-blue);
    margin: 0 0 0.75rem 0;
    font-weight: 600;
}

.filter-controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: flex-end;
    flex: 1;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.filter-group label {
    font-size: 0.75rem;
    color: var(--text-medium);
    font-weight: 600;
}

.filter-group select,
.filter-group input {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
    color: var(--text-dark);
    min-width: 130px;
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: var(--itscare-blue);
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
}

.filter-results {
    color: var(--text-medium);
    font-size: 0.85rem;
    padding: 0.4rem 0;
    font-weight: 600;
}

.btn-reset {
    background: var(--text-light);
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s;
    align-self: flex-end;
    height: fit-content;
}

.actions-section {
    padding-top: 0;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-wrap: nowrap;
    gap: 0.75rem;
}

.actions-section h3 {
    display: none; /* Hide actions heading */
}

.btn-reset:hover {
    background: var(--text-medium);
}

/* WebUI Links */
.webui-link {
    color: inherit;
    text-decoration: none;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.webui-link:hover {
    color: var(--itscare-blue);
    text-shadow: 0 0 10px rgba(0, 102, 204, 0.3);
}

.webui-link-icon {
    font-size: 0.85em;
    opacity: 0.7;
}

.detail-btn {
    background: var(--itscare-blue);
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
    font-weight: 600;
}

.detail-btn:hover {
    background: var(--itscare-blue-dark);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
}

.card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

{% endblock %}

{% block content %}

<!-- Combined Overview Card with Filters and Actions -->
<div class="overview-card">
    <div class="overview-header">
        <h2>Storage Systems Overview</h2>
    </div>
    
    <div class="overview-content">
        <div class="controls-wrapper">
            <!-- Filter Section -->
            <div class="filter-section">
                <h3>üîç Filter</h3>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="vendor-filter">Hersteller</label>
                        <select id="vendor-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="pure">Pure Storage</option>
                            <option value="netapp-ontap">NetApp ONTAP</option>
                            <option value="netapp-storagegrid">NetApp StorageGRID</option>
                            <option value="dell-datadomain">Dell DataDomain</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter">Status</label>
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="online">Healthy (Online)</option>
                            <option value="error">Unhealthy (Error)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="cluster-filter">Cluster-Typ</label>
                        <select id="cluster-filter" onchange="applyFilters()">
                            <option value="">Alle</option>
                            <option value="ha">HA</option>
                            <option value="active-cluster">Active-Cluster</option>
                            <option value="metrocluster">MetroCluster</option>
                            <option value="local">Local</option>
                            <option value="multi-site">Multi-Site</option>
                            <option value="single-site">Single-Site</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="search-filter">Suche</label>
                        <input type="text" id="search-filter" placeholder="Name, IP, DNS..." oninput="applyFilters()">
                    </div>
                    <button class="btn-reset" onclick="resetFilters()">Zur√ºcksetzen</button>
                    <div class="filter-results" id="filter-results"></div>
                </div>
            </div>
            
            <!-- Actions Section -->
            <div class="actions-section">
                <h3>Dashboard Optionen</h3>
                <div class="header-actions">
                    <div class="auto-refresh-control">
                        <label class="auto-refresh-label">
                            <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                            <span>Auto-Refresh</span>
                        </label>
                        <select id="refresh-interval" onchange="changeRefreshInterval()">
                            <option value="30">30s</option>
                            <option value="45">45s</option>
                            <option value="60">60s</option>
                            <option value="90">90s</option>
                            <option value="120">2min</option>
                        </select>
                        <span class="refresh-timer" id="refresh-timer"></span>
                    </div>
                    <div class="view-toggle">
                        <button id="card-view-btn" class="active" onclick="switchView('card')">
                            <span>&#x25A0;&#x25A0;</span> Cards
                        </button>
                        <button id="table-view-btn" onclick="switchView('table')">
                            <span>‚ò∞</span> Table
                        </button>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">&#x21bb; Aktualisieren</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not grouped_systems %}
<div class="no-systems">
    <h3>Keine Storage Systeme konfiguriert</h3>
    <p>F√ºgen Sie Storage Systeme im <a href="/admin">Admin-Bereich</a> hinzu.</p>
</div>
{% else %}
    {% for vendor, systems in grouped_systems.items() %}
    <div class="vendor-section">
        <div class="vendor-header">
            <span>{{ vendor_names[vendor] }}</span>
            <span class="vendor-count">{{ systems|length }} System{{ 'e' if systems|length != 1 else '' }}</span>
        </div>
        
        <!-- Card View -->
        <div class="systems-grid">
            {% for item in systems %}
            {% set system = item.system %}
            {% set status = item.status %}
            <div class="system-card" 
                 data-vendor="{{ vendor }}" 
                 data-status="{{ status.status }}"
                 data-cluster-type="{{ system.cluster_type or '' }}"
                 data-name="{{ system.name }}"
                 data-ip="{{ system.ip_address }}"
                 data-dns="{{ system.get_dns_names()[0] if system.get_dns_names() else '' }}">
                <div class="system-header">
                    <div class="system-name">
                        <a href="https://{% if system.get_dns_names() %}{{ system.get_dns_names()[0] }}{% else %}{{ system.ip_address }}{% endif %}" target="_blank" rel="noopener noreferrer" 
                           class="webui-link" title="Zur WebUI √∂ffnen">
                            {{ system.name }}
                            <span class="webui-link-icon">‚Üó</span>
                        </a>
                    </div>
                    {% if system.cluster_type %}
                    <span class="cluster-badge {{ system.cluster_type }}">
                        {% if system.cluster_type == 'ha' %}HA
                        {% elif system.cluster_type == 'active-cluster' %}Active
                        {% elif system.cluster_type == 'metrocluster' %}Metro
                        {% elif system.cluster_type == 'local' %}Local
                        {% elif system.cluster_type == 'multi-site' %}Multi-Site
                        {% elif system.cluster_type == 'single-site' %}Single
                        {% else %}{{ system.cluster_type }}{% endif %}
                    </span>
                    {% endif %}
                </div>
                <div class="system-ip">{{ system.ip_address }}</div>
                
                <span class="status-badge status-{{ status.status }}">
                    {% if status.status == 'online' %}‚úì Online
                    {% elif status.status == 'error' %}‚úó Fehler
                    {% else %}? Unbekannt{% endif %}
                </span>
                
                {% if system.node_count or system.site_count %}
                <div class="node-info">
                    {% if system.node_count %}{{ system.node_count }} Nodes{% endif %}
                    {% if system.node_count and system.site_count %} / {% endif %}
                    {% if system.site_count %}{{ system.site_count }} Sites{% endif %}
                </div>
                {% endif %}
                
                {% if status.status == 'online' %}
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-label">Hardware:</span>
                        <span class="metric-value metric-{{ status.hardware_status }}">
                            {{ status.hardware_status|upper }}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cluster:</span>
                        <span class="metric-value metric-{{ status.cluster_status }}">
                            {{ status.cluster_status|upper }}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Alerts:</span>
                        <span class="metric-value {% if status.alerts > 0 %}metric-warning{% endif %}">
                            {{ status.alerts }}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Kapazit√§t:</span>
                        <span class="metric-value">
                            {{ "%.1f"|format(status.capacity_used_tb) }} / {{ "%.1f"|format(status.capacity_total_tb) }} TB
                        </span>
                    </div>
                    <div class="capacity-bar">
                        <div class="capacity-fill {% if status.capacity_percent > 90 %}critical{% elif status.capacity_percent > 75 %}high{% endif %}" 
                             style="width: {{ status.capacity_percent }}%"></div>
                    </div>
                    <div class="capacity-text">
                        {{ "%.1f"|format(status.capacity_percent) }}% belegt
                    </div>
                </div>
                {% endif %}
                
                {% if status.error %}
                <div class="error-message">{{ status.error }}</div>
                {% endif %}
                
                <div class="card-actions">
                    <a href="/systems/{{ system.id }}/details" class="detail-btn">üìä Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Table View -->
        <div class="systems-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Cluster-Typ</th>
                        <th>IP</th>
                        <th class="status-cell">Status</th>
                        <th>Hardware</th>
                        <th>Cluster</th>
                        <th class="status-cell">Alerts</th>
                        <th class="capacity-cell">Kapazit√§t</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in systems %}
                    {% set system = item.system %}
                    {% set status = item.status %}
                    <tr data-vendor="{{ vendor }}" 
                        data-status="{{ status.status }}"
                        data-cluster-type="{{ system.cluster_type or '' }}"
                        data-name="{{ system.name }}"
                        data-ip="{{ system.ip_address }}"
                        data-dns="{{ system.get_dns_names()[0] if system.get_dns_names() else '' }}">
                        <td>
                            <a href="https://{% if system.get_dns_names() %}{{ system.get_dns_names()[0] }}{% else %}{{ system.ip_address }}{% endif %}" target="_blank" rel="noopener noreferrer" 
                               class="webui-link" title="Zur WebUI √∂ffnen" style="font-weight: bold;">
                                {{ system.name }} ‚Üó
                            </a>
                            {% if system.node_count or system.site_count %}
                            <br><small style="color: var(--text-light);">
                                {% if system.node_count %}{{ system.node_count }}N{% endif %}
                                {% if system.site_count %}/{{ system.site_count }}S{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            {% if system.cluster_type %}
                            <span class="cluster-badge {{ system.cluster_type }}">
                                {% if system.cluster_type == 'ha' %}HA
                                {% elif system.cluster_type == 'active-cluster' %}Active-Cluster
                                {% elif system.cluster_type == 'metrocluster' %}MetroCluster
                                {% elif system.cluster_type == 'local' %}Local
                                {% elif system.cluster_type == 'multi-site' %}Multi-Site
                                {% elif system.cluster_type == 'single-site' %}Single-Site
                                {% else %}{{ system.cluster_type }}{% endif %}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td><small style="font-family: 'Courier New', monospace;">{{ system.ip_address }}</small></td>
                        <td class="status-cell">
                            <span class="status-badge status-{{ status.status }}">
                                {% if status.status == 'online' %}‚úì
                                {% elif status.status == 'error' %}‚úó
                                {% else %}?{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if status.status == 'online' %}
                            <span class="metric-value metric-{{ status.hardware_status }}">
                                {{ status.hardware_status|upper }}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if status.status == 'online' %}
                            <span class="metric-value metric-{{ status.cluster_status }}">
                                {{ status.cluster_status|upper }}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="status-cell">
                            {% if status.status == 'online' %}
                            <span class="{% if status.alerts > 0 %}metric-warning{% endif %}">
                                {{ status.alerts }}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="capacity-cell">
                            {% if status.status == 'online' and status.capacity_total_tb > 0 %}
                            <div>
                                <small>{{ "%.1f"|format(status.capacity_used_tb) }} / {{ "%.1f"|format(status.capacity_total_tb) }} TB</small>
                            </div>
                            <div class="capacity-bar">
                                <div class="capacity-fill {% if status.capacity_percent > 90 %}critical{% elif status.capacity_percent > 75 %}high{% endif %}" 
                                     style="width: {{ status.capacity_percent }}%"></div>
                            </div>
                            <div class="capacity-text">{{ "%.1f"|format(status.capacity_percent) }}%</div>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            <a href="/systems/{{ system.id }}/details" class="detail-btn" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
{% endif %}

<div class="dashboard-footer">
    Powered by <a href="https://www.itscare.de" target="_blank">ITscare</a> | Storage Dashboard v1.0
</div>

<script>
// Auto-refresh configuration
const DEFAULT_REFRESH_INTERVAL = '45';  // Default refresh interval in seconds
let autoRefreshCountdown = null;
let refreshTimeSeconds = 45;
let countdownSeconds = refreshTimeSeconds;

// Initialize auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('dashboard-view') || 'card';
    switchView(savedView);
    applyFilters(); // Apply initial filters
    
    // Restore refresh interval preference
    const savedInterval = localStorage.getItem('refresh-interval') || DEFAULT_REFRESH_INTERVAL;
    refreshTimeSeconds = parseInt(savedInterval, 10);
    document.getElementById('refresh-interval').value = savedInterval;
    
    // Restore auto-refresh preference
    const autoRefreshEnabled = localStorage.getItem('auto-refresh-enabled') === 'true';
    document.getElementById('auto-refresh-toggle').checked = autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        startAutoRefresh();
    } else {
        updateTimerDisplay();
    }
});

function changeRefreshInterval() {
    const newInterval = parseInt(document.getElementById('refresh-interval').value, 10);
    refreshTimeSeconds = newInterval;
    localStorage.setItem('refresh-interval', newInterval);
    
    // If auto-refresh is active, restart with new interval
    if (document.getElementById('auto-refresh-toggle').checked) {
        startAutoRefresh();
    }
}

function toggleAutoRefresh() {
    const isEnabled = document.getElementById('auto-refresh-toggle').checked;
    localStorage.setItem('auto-refresh-enabled', isEnabled);
    
    if (isEnabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    // Clear any existing intervals
    stopAutoRefresh();
    
    // Reset countdown
    countdownSeconds = refreshTimeSeconds;
    updateTimerDisplay();
    
    // Start countdown timer (updates every second)
    autoRefreshCountdown = setInterval(function() {
        countdownSeconds--;
        updateTimerDisplay();
        
        // Trigger refresh when countdown reaches zero
        if (countdownSeconds <= 0) {
            refreshDashboard();
            return; // Exit early as refreshDashboard will reload the page
        }
    }, 1000);
}

function stopAutoRefresh() {
    if (autoRefreshCountdown) {
        clearInterval(autoRefreshCountdown);
        autoRefreshCountdown = null;
    }
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('refresh-timer');
    const isEnabled = document.getElementById('auto-refresh-toggle').checked;
    
    if (isEnabled) {
        timerElement.textContent = `${countdownSeconds}s`;
        timerElement.classList.remove('refreshing');
    } else {
        timerElement.textContent = '';
        timerElement.classList.remove('refreshing');
    }
}

function refreshDashboard() {
    const timerElement = document.getElementById('refresh-timer');
    timerElement.textContent = 'L√§dt...';
    timerElement.classList.add('refreshing');
    
    // Reload the page
    location.reload();
}

function manualRefresh() {
    // If auto-refresh is enabled, it will restart after reload
    // No need to manipulate intervals as the page reload will handle it
    location.reload();
}

// View switching with localStorage persistence
function switchView(view) {
    const cardBtn = document.getElementById('card-view-btn');
    const tableBtn = document.getElementById('table-view-btn');
    
    if (view === 'card') {
        document.body.classList.remove('table-view');
        cardBtn.classList.add('active');
        tableBtn.classList.remove('active');
    } else {
        document.body.classList.add('table-view');
        tableBtn.classList.add('active');
        cardBtn.classList.remove('active');
    }
    
    // Save preference
    localStorage.setItem('dashboard-view', view);
}

// Filter logic
function applyFilters() {
    const vendorFilter = document.getElementById('vendor-filter').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value.toLowerCase();
    const clusterFilter = document.getElementById('cluster-filter').value.toLowerCase();
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    // Get all system cards and table rows
    const systemCards = document.querySelectorAll('.system-card');
    const tableRows = document.querySelectorAll('.systems-table tbody tr');
    
    let visibleCount = 0;
    let totalCount = systemCards.length;
    
    // Filter cards
    systemCards.forEach(card => {
        const vendor = card.dataset.vendor || '';
        const status = card.dataset.status || '';
        const clusterType = card.dataset.clusterType || '';
        const name = card.dataset.name || '';
        const ip = card.dataset.ip || '';
        const dns = card.dataset.dns || '';
        
        const matchVendor = !vendorFilter || vendor.includes(vendorFilter);
        const matchStatus = !statusFilter || status === statusFilter;
        const matchCluster = !clusterFilter || clusterType === clusterFilter;
        const matchSearch = !searchFilter || 
            name.toLowerCase().includes(searchFilter) ||
            ip.includes(searchFilter) ||
            dns.toLowerCase().includes(searchFilter);
        
        if (matchVendor && matchStatus && matchCluster && matchSearch) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Filter table rows
    tableRows.forEach(row => {
        const vendor = row.dataset.vendor || '';
        const status = row.dataset.status || '';
        const clusterType = row.dataset.clusterType || '';
        const name = row.dataset.name || '';
        const ip = row.dataset.ip || '';
        const dns = row.dataset.dns || '';
        
        const matchVendor = !vendorFilter || vendor.includes(vendorFilter);
        const matchStatus = !statusFilter || status === statusFilter;
        const matchCluster = !clusterFilter || clusterType === clusterFilter;
        const matchSearch = !searchFilter || 
            name.toLowerCase().includes(searchFilter) ||
            ip.includes(searchFilter) ||
            dns.toLowerCase().includes(searchFilter);
        
        if (matchVendor && matchStatus && matchCluster && matchSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update filter results
    const resultsDiv = document.getElementById('filter-results');
    resultsDiv.textContent = `${visibleCount} von ${totalCount} Systemen angezeigt`;
    
    // Show/hide vendor sections if all items are hidden
    document.querySelectorAll('.vendor-section').forEach(section => {
        const visibleCards = section.querySelectorAll('.system-card:not([style*="display: none"])');
        const visibleRows = section.querySelectorAll('.systems-table tbody tr:not([style*="display: none"])');
        
        if (visibleCards.length === 0 && visibleRows.length === 0) {
            section.style.display = 'none';
        } else {
            section.style.display = '';
        }
    });
}

// Reset filters
function resetFilters() {
    document.getElementById('vendor-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('cluster-filter').value = '';
    document.getElementById('search-filter').value = '';
    applyFilters();
}
</script>
{% endblock %}
